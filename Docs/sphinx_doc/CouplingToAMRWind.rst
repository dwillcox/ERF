
 .. role:: cpp(code)
    :language: c++

 .. role:: fortran(code)
    :language: fortran

 .. _CouplingToAMRWind:

Coupling To AMR-Wind
====================

The simplest form of coupling is one-way, file-based coupling. With this approach, an
ERF simulation is run and output files with relevant simulation data are stored at
regular time intervals. Once the ERF simulation is complete, an AMR-Wind simulation
begins, using the ERF output files as time-dependent boundary conditions or forcing.

1D File-based coupling
----------------------

The 1D file-based coupling scheme is based on the Time-Height Profile Assimilation
Technique proposed by `Allaerts et al. <https://doi.org/10.1007/s10546-020-00538-5>`_
In this approach, the time evolution of the vertical profile of the horizontal
velocity components and potential temperature at a particular position from the
mesoscale simulation is saved, and a forcing term is added to the microscale simulation
to indirectly assimilate the mesoscale data at the microscale.
The output files generated by ERF are NetCDF files of a format compatable with the
`AMR-Wind implementation <https://github.com/shashankNREL/amr-wind/blob/sy/almForceWrf/amr-wind/wind_energy/ABLWrf.cpp>`_
of this form of coupling.

We note that the solution variables in ERF are

.. math::

    (\rho, \rho u, \rho v, \rho w, \rho \theta)

while those in AMR-Wind are

.. math::

    (u, v, w, T, p)

We convert the variables from conservative to primitive form prior to saving the
output files.

The following parameters control the generation of 1D column output files in ERF. To
use this capability, the user must install the `NetCDF library
<http://doi.org/10.5065/D6H70CW6>`_ and link to it at compile time, which can be done
by setting `USE_NETCDF = TRUE` in the GNUMakefile for ERF.

+----------------------------+------------------+------------------+-----------------+
| Parameter                  | Definition       | Acceptable       | Default         |
|                            |                  | Values           |                 |
+============================+==================+==================+=================+
| **erf.output_1d_column**   | whether to output| 0 or 1           | 0               |
|                            | for coupling     |                  |                 |
|                            | to AMR-Wind      |                  |                 |
+----------------------------+------------------+------------------+-----------------+
| **erf.column_file_name**   | prefix for       | String           | “column_data.nc”|
|                            | output files     |                  |                 |
+----------------------------+------------------+------------------+-----------------+
| **erf.column_interval**    | how often (by    | Integer          | -1              |
|                            | level-0 time     | :math:`> 0`      |                 |
|                            | steps) to output |                  |                 |
|                            | data files       |                  |                 |
+----------------------------+------------------+------------------+-----------------+
| **erf.column_per**         | how often (by    | Real :math:`> 0` | -1.0            |
|                            | simulation time) |                  |                 |
|                            | to write output  |                  |                 |
|                            | data files       |                  |                 |
+----------------------------+------------------+------------------+-----------------+
| **erf.column_loc_x**       | x-coordinate     | prob_lo(0) <= x  | 0.0             |
|                            | where vertical   | <= prob_hi(0)    |                 |
|                            | profile will be  |                  |                 |
|                            | extracted        |                  |                 |
+----------------------------+------------------+------------------+-----------------+
| **erf.column_loc_y**       | y-coordinate     | prob_lo(1) <= y  | 0.0             |
|                            | where vertical   | <= prob_hi(1)    |                 |
|                            | profile will be  |                  |                 |
|                            | extracted        |                  |                 |
+----------------------------+------------------+------------------+-----------------+


*  You should specify either **erf.output_int** or **erf.output_per**, but not both.

.. note::

    Everything below is a work in progress

2D File-based coupling
----------------------

In 2D file-based coupling, vertical planes will be saved from ERF to be used to define inlet
boundary conditions for AMR-Wind. These files will also be NetCDF format and will comply
with the file structure described in the
`AMR-Wind documentation <https://exawind.github.io/amr-wind/user/abl_bndry_io.html>`_.
